/**
 * Compte d'Exploitation Bancaire
 * PNB (Produit Net Bancaire), charges d'exploitation, resultat
 */

import React, { memo } from 'react'
import {
  Table, TableBody, TableCell, TableContainer, TableHead, TableRow,
  Paper, Typography, Box, TextField, Chip,
} from '@mui/material'

interface CompteExploitationBanqueProps {
  modeEdition?: boolean
}

const formatMontant = (val: number | null): string => {
  if (val === null || val === undefined) return ''
  return new Intl.NumberFormat('fr-FR').format(val)
}

const CompteExploitationBanque: React.FC<CompteExploitationBanqueProps> = ({ modeEdition = false }) => {
  const lignes = [
    { ref: '', libelle: 'PRODUITS BANCAIRES', montantN: null, montantN1: null, isHeader: true },
    { ref: 'PB_1', libelle: 'Produits sur operations de tresorerie', montantN: 0, montantN1: 0 },
    { ref: 'PB_2', libelle: 'Produits sur operations avec clientele', montantN: 0, montantN1: 0 },
    { ref: 'PB_3', libelle: 'Produits sur operations sur titres', montantN: 0, montantN1: 0 },
    { ref: 'PB_4', libelle: 'Produits sur operations de change', montantN: 0, montantN1: 0 },
    { ref: 'PB_5', libelle: 'Produits sur operations de hors-bilan', montantN: 0, montantN1: 0 },
    { ref: 'PB_6', libelle: 'Produits sur prestations financieres', montantN: 0, montantN1: 0 },
    { ref: 'PB_7', libelle: 'Autres produits d\'exploitation bancaire', montantN: 0, montantN1: 0 },
    { ref: '', libelle: 'TOTAL PRODUITS BANCAIRES', montantN: 0, montantN1: 0, isTotal: true },

    { ref: '', libelle: 'CHARGES BANCAIRES', montantN: null, montantN1: null, isHeader: true },
    { ref: 'CB_1', libelle: 'Charges sur operations de tresorerie', montantN: 0, montantN1: 0 },
    { ref: 'CB_2', libelle: 'Charges sur operations avec clientele', montantN: 0, montantN1: 0 },
    { ref: 'CB_3', libelle: 'Charges sur operations sur titres', montantN: 0, montantN1: 0 },
    { ref: 'CB_4', libelle: 'Charges sur operations de change', montantN: 0, montantN1: 0 },
    { ref: 'CB_5', libelle: 'Charges sur operations de hors-bilan', montantN: 0, montantN1: 0 },
    { ref: 'CB_6', libelle: 'Charges sur prestations financieres', montantN: 0, montantN1: 0 },
    { ref: '', libelle: 'TOTAL CHARGES BANCAIRES', montantN: 0, montantN1: 0, isTotal: true },

    { ref: 'PNB', libelle: 'PRODUIT NET BANCAIRE (PNB)', montantN: 0, montantN1: 0, isTotalGeneral: true },

    { ref: '', libelle: 'CHARGES D\'EXPLOITATION', montantN: null, montantN1: null, isHeader: true },
    { ref: 'CB_7', libelle: 'Charges generales d\'exploitation', montantN: 0, montantN1: 0 },
    { ref: 'CB_8', libelle: 'Frais de personnel', montantN: 0, montantN1: 0 },
    { ref: 'CB_9', libelle: 'Dotations amortissements et provisions', montantN: 0, montantN1: 0 },
    { ref: '', libelle: 'TOTAL CHARGES D\'EXPLOITATION', montantN: 0, montantN1: 0, isTotal: true },

    { ref: '', libelle: 'AUTRES', montantN: null, montantN1: null, isHeader: true },
    { ref: 'PB_8', libelle: 'Produits accessoires', montantN: 0, montantN1: 0 },
    { ref: 'PB_9', libelle: 'Reprises de provisions', montantN: 0, montantN1: 0 },
    { ref: 'PB_10', libelle: 'Produits exceptionnels', montantN: 0, montantN1: 0 },
    { ref: 'CB_10', libelle: 'Charges exceptionnelles et impot', montantN: 0, montantN1: 0 },

    { ref: 'RN', libelle: 'RESULTAT NET', montantN: 0, montantN1: 0, isTotalGeneral: true },
  ]

  return (
    <Box>
      <Typography variant="h5" gutterBottom sx={{ mb: 3 }}>Compte d'Exploitation Bancaire</Typography>
      <TableContainer component={Paper}>
        <Box sx={{ p: 2, bgcolor: '#1565c0', color: 'white' }}>
          <Typography variant="h6">Compte d'Exploitation</Typography>
          <Chip label="BANQUE - PCEC/PCB" size="small" sx={{ mt: 0.5, bgcolor: 'rgba(255,255,255,0.2)', color: 'white' }} />
        </Box>
        <Table size="small">
          <TableHead>
            <TableRow sx={{ bgcolor: 'grey.100' }}>
              <TableCell sx={{ width: 80, fontWeight: 'bold' }}>Ref</TableCell>
              <TableCell sx={{ fontWeight: 'bold' }}>Libelle</TableCell>
              <TableCell align="right" sx={{ width: 150, fontWeight: 'bold' }}>Exercice N</TableCell>
              <TableCell align="right" sx={{ width: 150, fontWeight: 'bold' }}>Exercice N-1</TableCell>
            </TableRow>
          </TableHead>
          <TableBody>
            {lignes.map((ligne, idx) => {
              const isHeader = 'isHeader' in ligne && ligne.isHeader
              const isTotal = 'isTotal' in ligne && ligne.isTotal
              const isTotalGeneral = 'isTotalGeneral' in ligne && ligne.isTotalGeneral
              return (
                <TableRow key={idx} sx={{
                  bgcolor: isHeader ? '#e3f2fd' : isTotalGeneral ? '#fff3e0' : isTotal ? 'grey.50' : 'white',
                  '& td': {
                    fontWeight: (isHeader || isTotal || isTotalGeneral) ? 'bold' : 'normal',
                    fontSize: isTotalGeneral ? '0.95rem' : '0.85rem',
                    borderBottom: isTotalGeneral ? '3px double' : isTotal ? '2px solid #ccc' : undefined,
                    color: isHeader ? '#1565c0' : isTotalGeneral ? '#e65100' : undefined,
                  },
                }}>
                  <TableCell>{ligne.ref}</TableCell>
                  <TableCell>{ligne.libelle}</TableCell>
                  <TableCell align="right">
                    {ligne.montantN !== null ? (modeEdition && !isHeader && !isTotal && !isTotalGeneral ? (
                      <TextField size="small" type="number" defaultValue={ligne.montantN} sx={{ width: 130 }} InputProps={{ sx: { fontSize: '0.85rem' } }} />
                    ) : formatMontant(ligne.montantN)) : ''}
                  </TableCell>
                  <TableCell align="right">
                    {ligne.montantN1 !== null ? (modeEdition && !isHeader && !isTotal && !isTotalGeneral ? (
                      <TextField size="small" type="number" defaultValue={ligne.montantN1} sx={{ width: 130 }} InputProps={{ sx: { fontSize: '0.85rem' } }} />
                    ) : formatMontant(ligne.montantN1)) : ''}
                  </TableCell>
                </TableRow>
              )
            })}
          </TableBody>
        </Table>
      </TableContainer>
    </Box>
  )
}

export default memo(CompteExploitationBanque)
